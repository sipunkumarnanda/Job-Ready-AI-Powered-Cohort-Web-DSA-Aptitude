

# ğŸ§© **Mongoose Virtuals â€” Complete In-Depth Notes (Beginner â†’ Advanced)**

âœ¨ *Clean. Full. Professional. All concepts in one place.*

---

# ğŸ“˜ **1. What Are Virtuals in Mongoose?**

### âœ¨ Simple Definition

**Virtuals are fields that do NOT exist in MongoDB, but appear on Mongoose Documents when accessed.**

They are:

* âŒ Not stored in the database
* ğŸ§  Computed **on the fly**
* âš™ï¸ Defined on **Schema**, not Model
* ğŸ“¤ Usable in templates, JSON responses, views, etc.
* ğŸ§® Similar to â€œformula fieldsâ€ in spreadsheets

---

# ğŸ’¡ **2. Why Do We Use Virtuals?**

Virtuals help you create **derived, computed, or formatted** values without storing extra fields.

### Common use cases

âœ” Combine fields
â†’ `firstName + lastName = fullName`

âœ” Convert raw data
â†’ `createdAt â†’ formattedDate`

âœ” Derived data
â†’ calculate `age` from `dob`

âœ” Create URLs
â†’ `/users/<id>`

âœ” Format data for API responses
â†’ without storing unnecessary fields

---

# ğŸ§  **3. Virtuals Are Not Stored in MongoDB (Very Important)**

MongoDB documents:

```json
{
  "_id": "u1",
  "firstName": "Alex",
  "lastName": "Johnson"
}
```

The virtual:

```txt
fullName = "Alex Johnson"
```

does **NOT** exist in DB.
It exists **only in the Mongoose Document** when you access it.

---

# ğŸ”§ **4. How Virtuals Work (Conceptual)**

### Virtuals belong to the **Schema**, not the Model.

Why?

* Schema = description of structure + behavior
* Model = constructor created FROM the schema
* Documents = instances created BY the model

ğŸ“˜ **Schema = blueprint**
ğŸ­ **Model = factory**
ğŸ“„ **Document = final object**
ğŸ’¡ **Virtuals = blueprint instructions** applied on every document

---

# ğŸ§© **5. Creating a Virtual â€” Full Example**

```js
const UserSchema = new mongoose.Schema({
  firstName: String,
  lastName: String
});

// Define virtual
UserSchema.virtual("fullName").get(function () {
  return this.firstName + " " + this.lastName;
});
```

---

# ğŸ§µ **6. Line-by-Line Explanation (Beginner Friendly)**

### 1ï¸âƒ£ Define Schema

```js
const UserSchema = new mongoose.Schema({
  firstName: String,
  lastName: String
});
```

* Creates a schema describing what a user document looks like.
* Only `firstName` and `lastName` are stored in MongoDB.

---

### 2ï¸âƒ£ Define Virtual Name

```js
UserSchema.virtual("fullName")
```

* You declare a virtual property called `fullName`.
* This is NOT a real DB field.

---

### 3ï¸âƒ£ Define Getter Function

```js
.get(function () {
```

* `.get()` means:

  > â€œWhenever someone READS `user.fullName`, run this function.â€

* Inside the function, `this` refers to the **current document**.

---

### 4ï¸âƒ£ Return Virtual Value

```js
return this.firstName + " " + this.lastName;
```

* Combines the stored fields.
* Example output: `"Alex Johnson"`.

---

# ğŸ§ª **7. Using the Virtual**

```js
const User = mongoose.model("User", UserSchema);

const user = await User.findById("u1");

console.log(user.fullName);
```

### Output:

```
Alex Johnson
```

âœ” Even though not saved in DB
âœ” It works like normal property
âœ” Computed instantly when accessed

---

# ğŸ“¤ **8. Showing Virtuals in JSON / API Responses**

By default, virtuals **do not** appear in:

* `res.json()`
* `.toJSON()`
* `.toObject()`

To enable them:

```js
UserSchema.set("toJSON", { virtuals: true });
UserSchema.set("toObject", { virtuals: true });
```

---

# ğŸ§µ **Line-by-Line Explanation**

### 1ï¸âƒ£

```js
UserSchema.set("toJSON", { virtuals: true });
```

* When converting Document â†’ JSON (API responses)
* Include virtuals

### 2ï¸âƒ£

```js
UserSchema.set("toObject", { virtuals: true });
```

* When converting Document â†’ plain object internally
* Include virtuals here too

Without this, **virtuals wonâ€™t appear in res.json()**.

---

# ğŸ§© **9. Full Working Example**

```js
const UserSchema = new mongoose.Schema({
  firstName: String,
  lastName: String
});

// Virtual
UserSchema.virtual("fullName").get(function () {
  return this.firstName + " " + this.lastName;
});

// Enable virtuals in output
UserSchema.set("toJSON", { virtuals: true });
UserSchema.set("toObject", { virtuals: true });

const User = mongoose.model("User", UserSchema);

// Usage
const user = await User.findById("u1");
console.log(user.fullName);

// API
res.json(user);
```

### Output:

```json
{
  "firstName": "Alex",
  "lastName": "Johnson",
  "fullName": "Alex Johnson"
}
```

---

# ğŸ”¥ **10. Useful Virtual Examples**

## â­ Example 1 â€” Age from Date of Birth

```js
UserSchema.virtual("age").get(function () {
  const diff = Date.now() - this.dob.getTime();
  return Math.floor(diff / (365.25 * 24 * 60 * 60 * 1000));
});
```

Why useful?

* Age always stays correct
* No need to save `age` in DB

---

## â­ Example 2 â€” Profile URL

```js
UserSchema.virtual("profileUrl").get(function () {
  return `/users/${this._id}`;
});
```

Good for:

* Server-side rendering
* Links in API

---

## â­ Example 3 â€” Full Address

```js
AddressSchema.virtual("fullAddress").get(function () {
  return `${this.street}, ${this.city}, ${this.country}`;
});
```

Great for UI formatting.

---

# âš¡ **11. Important Gotchas / Limitations**

### â— 1. Virtuals do NOT work with `.lean()` by default

```js
await User.find().lean();
```

Virtuals will NOT appear.

### âœ” Solutions:

* Use plugin: `mongoose-lean-virtuals`
* OR compute manually
* OR avoid `.lean()` when virtuals needed

---

### â— 2. Virtuals CANNOT be used in MongoDB queries

```js
User.find({ fullName: "John Doe" }); // âŒ Not possible
```

Because there is **no fullName field** in the database.

---

### â— 3. Virtuals only run on Documents

They do NOT run on plain objects returned by `.lean()`.

---

# ğŸ§¾ **12. Virtuals vs Getters â€” Quick Comparison**

| Feature                | Virtuals            | Getters                      |
| ---------------------- | ------------------- | ---------------------------- |
| Saved in DB?           | âŒ No                | âŒ No                         |
| Based on other fields? | âœ” Yes               | âœ” Yes                        |
| Run when reading?      | âœ” Yes               | âœ” Yes                        |
| Run when writing?      | âŒ No                | âœ” Setter                     |
| Show in JSON?          | Only if enabled     | Only if enabled              |
| Work with `.lean()`?   | âŒ No (default)      | âŒ No (default)               |
| Ideal use              | fullName, age, URLs | formatting (lowercase email) |

---

# ğŸ“„ **13. Mini Cheat Sheet for Revision**

```
Virtuals = computed fields on documents
Not stored in MongoDB
Defined on Schema (never Model)
Documents inherit virtuals from Schema

Enable in output:
  Schema.set('toJSON', { virtuals: true })
  Schema.set('toObject', { virtuals: true })

Do NOT work with .lean() unless plugin
Cannot be used in DB queries
Useful for:
  - Combining fields
  - Deriving values (age)
  - Formatting (addresses)
  - URL generation
```

---

# ğŸ **14. Final Summary (Absolute Essentials)**

### âœ” Virtuals exist only in Mongoose, not MongoDB

### âœ” Virtuals are defined on **Schema**, not Model

### âœ” Documents inherit virtuals automatically

### âœ” You must enable them in JSON output

### âœ” Virtuals donâ€™t work with `.lean()` by default

### âœ” They cannot be queried in MongoDB

### âœ” Great for fullName, age, URLs, formatting

---