
## üìÅ `storage.service.js`

```js
import dotenv from 'dotenv'; 
import ImageKit from 'imagekit';

dotenv.config();

const imagekit = new ImageKit({
  publicKey: process.env.IMAGEKIT_PUBLIC_KEY,
  privateKey: process.env.IMAGEKIT_PRIVATE_KEY,
  urlEndpoint: process.env.IMAGEKIT_URL_ENDPOINT,
});

async function uploadFile(file, fileName) {
   try {
     const response = await imagekit.upload({
      file: file,
      fileName: fileName,
      folder : "/caption_generator"
    });
    return response;
   } catch (error) {
    console.error('ImageKit upload failed:', error.message);
    throw error;
   }
}

export default uploadFile;
```

---

## üìÅ `post.controller.js`

```js
import { generateCaption } from "../services/ai.service.js";
import postModel from '../models/post.model.js';
import uploadFile from "../services/storage.service.js";
import { v4 as uuidv4 } from "uuid";

const createPostController = async (req, res) => {
  try {
    const file = req.file;
    console.log(file);

    const base64Image = file.buffer.toString("base64");
    const caption = await generateCaption(base64Image);
    const result = await uploadFile(file.buffer, `${uuidv4()}`);

    const post = await postModel.create({
        caption : caption,
        image : result.url,
        user : req.user._id
    });

    res.status(201).json({
        post
    });
    
  } catch (error) {
    res.status(500).json({
      message: "Upload failed",
      error: error.message,
    });
  }
};

export default createPostController;
```

---

## üìò Explanation

---

### üîπ 1. `storage.service.js`

**Purpose**: To handle the image upload to the **ImageKit** CDN.

#### üì¶ Dependencies:

* `dotenv`: Loads `.env` variables (API keys, endpoints).
* `imagekit`: Official ImageKit SDK for uploading files.

#### üîê Configuration:

```js
dotenv.config();
```

This loads environment variables like:

* `IMAGEKIT_PUBLIC_KEY`
* `IMAGEKIT_PRIVATE_KEY`
* `IMAGEKIT_URL_ENDPOINT`

These are used to connect securely to your ImageKit account.

#### üîß Creating the ImageKit Client:

```js
const imagekit = new ImageKit({...});
```

Sets up an instance of the ImageKit client using credentials.

#### üì§ Upload Function:

```js
async function uploadFile(file, fileName) { ... }
```

* `file`: The binary data (image file buffer).
* `fileName`: A unique name for the file (e.g., using `uuidv4()`).

It uploads the file to a folder `/caption_generator` on ImageKit.

* On **success**, it returns the upload response.
* On **failure**, it logs the error and throws it again.

---

### üîπ 2. `post.controller.js`

**Purpose**: To process the image upload request, generate a caption using AI, upload the image, and save the post to MongoDB.

#### üì¶ Dependencies:

* `generateCaption`: (From AI service) Generates a caption for the image.
* `postModel`: Mongoose model to store post data in the DB.
* `uploadFile`: Imports the upload logic from `storage.service.js`.
* `uuidv4`: Generates a unique filename for each image.

---

### ‚öôÔ∏è Controller Function: `createPostController`

#### ‚úÖ Steps:

1. **Extract the file from request:**

```js
const file = req.file;
```

2. **Convert image buffer to Base64:**

```js
const base64Image = file.buffer.toString("base64");
```

Used as input to the AI caption generator.

3. **Generate a caption using AI:**

```js
const caption = await generateCaption(base64Image);
```

4. **Upload the image to ImageKit:**

```js
const result = await uploadFile(file.buffer, `${uuidv4()}`);
```

* `file.buffer` is the raw image.
* `uuidv4()` ensures a unique filename.

5. **Save the post in MongoDB:**

```js
const post = await postModel.create({
  caption: caption,
  image: result.url,
  user: req.user._id
});
```

* Stores caption, image URL, and user reference.

6. **Respond with success:**

```js
res.status(201).json({ post });
```

7. **Handle any errors:**

```js
res.status(500).json({
  message: "Upload failed",
  error: error.message,
});
```

---

### üìå Summary Table

| Part                             | Role                                                         |
| -------------------------------- | ------------------------------------------------------------ |
| `storage.service.js`             | Uploads image to ImageKit                                    |
| `post.controller.js`             | Creates post: generates caption + uploads image + saves post |
| `generateCaption()`              | Uses AI to generate image captions                           |
| `file.buffer.toString("base64")` | Converts image to base64 for captioning                      |
| `uploadFile()`                   | Uploads image to CDN                                         |
| `uuidv4()`                       | Ensures filename uniqueness                                  |
| `req.user._id`                   | References the authenticated user                            |

---