
# üß© How to use **EJS with Express** ‚Äî step-by-step (in-depth) ‚ú®

## ‚úÖ Project quick-start (commands)

```bash
mkdir express-ejs-example
cd express-ejs-example
npm init -y
npm install express ejs
npm install --save-dev nodemon      # optional for development
```

Add helpful scripts in `package.json`:

```json
"scripts": {
  "start": "node server.js",
  "dev": "nodemon server.js"
}
```

---

## Step 1 ‚Äî Install EJS

**Command:** `npm i ejs` (you also need `express`)

Why: Installing `ejs` makes the EJS template engine available to Express so you can use `res.render()` to produce HTML from templates.

Tip: also install `nodemon` for live reload during development (`npm i -D nodemon`).

---

## Step 2 ‚Äî Create a `views` folder and template files

By default Express looks for templates in a folder named `views`. Put your `.ejs` files there.

Recommended structure (simple):

```
/project-root
  server.js
  /src
    app.js
    /views
      index.ejs
      /partials
        header.ejs
        footer.ejs
    /public
      /css
        style.css
```

**Example `views/index.ejs`:**

```ejs
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>My EJS Page</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <%- include('partials/header') %>

  <h1><%= message %></h1>

  <ul>
    <% posts.forEach(function(p) { %>
      <li><%= p.title %></li>
    <% }); %>
  </ul>

  <%- include('partials/footer') %>
</body>
</html>
```

Notes:

* Write normal HTML inside `.ejs` files.
* Use EJS tags for dynamic content (`<%= %>`, `<% %>`, `<%- %>` ‚Äî explained later).

---

## Step 3 ‚Äî Configure Express (e.g., in `src/app.js`)

Set the view engine and register `express.static` to serve public assets.

**`src/app.js`**

```js
const express = require('express');
const path = require('path');

const app = express();

// set the directory that contains view templates (relative to this file)
app.set('views', path.join(__dirname, 'views'));

// tell Express to use EJS as the view engine
app.set('view engine', 'ejs');

// serve static files from src/public (CSS, client JS, images)
app.use(express.static(path.join(__dirname, 'public')));

// parsers for form & JSON bodies
app.use(express.urlencoded({ extended: true }));
app.use(express.json());

module.exports = app;
```

Why:

* `app.set('view engine', 'ejs')` tells `res.render('name')` to look for `name.ejs` and process it with EJS.
* `app.use(express.static(...))` exposes `/css/style.css` etc. so your EJS pages can reference them with `/css/style.css`.

Common pitfall: wrong `views` path ‚Üí Express can‚Äôt find your templates. Use `path.join(__dirname, 'views')` so it‚Äôs correct relative to file.

---

## Step 4 ‚Äî Define routes and render views (in `server.js` or a routes file)

You can define routes anywhere ‚Äî but pattern: configure app in `src/app.js` and start server + mount routes in `server.js`.

**`server.js`**

```js
const app = require('./src/app');

const posts = [
  { id: 1, title: 'Hello from EJS' },
  { id: 2, title: 'Server-side rendering' }
];

// Route that renders HTML via EJS
app.get('/', (req, res) => {
  res.render('index', { message: 'Hello from EJS', posts });
});

// Example API route that returns JSON (coexists with EJS)
app.get('/api/posts', (req, res) => {
  res.json(posts);
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => console.log(`Server running on http://localhost:${PORT}`));
```

**Key:** `res.render('index', { message: 'Hello from EJS' })`:

* `index` ‚Üí name of the view (Express will add `.ejs` because you set the view engine).
* 2nd arg is an object ‚Äî **locals** available inside the template (`message` and `posts` above).

---

## üîç EJS tag reference (what each tag does)

* `<% code %>` ‚Äî run JS code (no direct output).
* `<%= value %>` ‚Äî **escaped** output (safe for user content).
* `<%- value %>` ‚Äî **unescaped/raw** output (dangerous if content not sanitized).
* `<%# comment %>` ‚Äî template comment (not shown in HTML).

Example:

```ejs
<p>User: <%= user.name %></p>
<% if (user.isAdmin) { %>
  <p>Welcome, admin!</p>
<% } %>
```

Security note: prefer `<%= %>` for user data to avoid XSS. Only use `<%- %>` for sanitized/trusted HTML.

---

## Advanced usage & tips

### Passing complex data & arrays

You can pass arrays/objects:

```js
res.render('index', { user, posts, settings });
```

Access them directly in EJS: `posts.forEach(...)`, `user.email`, etc.

### Using partials / includes (DRY)

Create `views/partials/header.ejs` and `footer.ejs`. Include with:

```ejs
<%- include('partials/header') %>
```

### Layouts

EJS has no built-in layout, use `express-ejs-layouts` or `ejs-mate` for layout support:

```bash
npm i express-ejs-layouts
```

Then configure and use `layout.ejs` with a `<%- body %>` placeholder.

### Render to string (useful for emails)

`res.render('template', data, (err, html) => { /* html is generated string */ })`
Good for creating HTML email bodies or screenshotting pages.

### Embedding server data into client JS safely

To pass initial data to client-side scripts:

```ejs
<script>
  window.__INITIAL_DATA__ = <%- JSON.stringify(data).replace(/</g, '\\u003c') %>;
</script>
```

Replace `<` to avoid breaking out of `<script>` and reduce XSS risks.

### Forms & PRG pattern

* Use `express.urlencoded()` to parse form data.
* After POST, use `res.redirect()` (Post-Redirect-Get) to avoid form re-submission on refresh.

### Error handling

In async routes, catch errors and call `next(err)`. Use an error-handling middleware:

```js
app.use((err, req, res, next) => {
  console.error(err);
  res.status(500).render('error', { error: err });
});
```

---

## üö® Security & production tips

* Use `helmet()` for security headers.
* Use CSRF protection (`csurf`) for POST forms.
* Validate/sanitize all incoming data (`express-validator`, Joi).
* Use `<%= %>` for untrusted content to escape it.
* In production enable template caching:

  ```js
  app.set('view cache', true);
  ```
* Serve static files via CDN for better performance.

---

## ‚ö° Performance & caching

* `app.set('view cache', true)` caches compiled templates. Good for production.
* Use `compression()` for gzip.
* Avoid heavy logic in templates ‚Äî prepare data in controllers.

---

## ‚úÖ Common issues & fixes

* **Express throws ‚ÄúCannot find module ejs‚Äù** ‚Üí run `npm i ejs`.
* **Templates not found** ‚Üí check `app.set('views', ...)` path and file names.
* **CSS not loading** ‚Üí confirm `express.static()` path and that you reference assets as `/css/style.css`.
* **Unescaped HTML shows script injection** ‚Üí use `<%= %>` (escaped) not `<%- %>`.

---

## Example: full minimal files (copy-paste)

**`src/app.js`**

```js
const express = require('express');
const path = require('path');
const app = express();

app.set('views', path.join(__dirname, 'views'));
app.set('view engine', 'ejs');

app.use(express.static(path.join(__dirname, 'public')));
app.use(express.urlencoded({ extended: true }));
app.use(express.json());

module.exports = app;
```

**`server.js`**

```js
const app = require('./src/app');

const posts = [{ id:1, title: 'Hello' }];

app.get('/', (req, res) => {
  res.render('index', { message: 'Hello from EJS', posts });
});

app.listen(3000, () => console.log('Server: http://localhost:3000'));
```

**`src/views/index.ejs`**

```ejs
<!doctype html>
<html>
<head><meta charset="utf-8"><title>EJS Example</title><link rel="stylesheet" href="/css/style.css"></head>
<body>
  <h1><%= message %></h1>
  <ul><% posts.forEach(p => { %><li><%= p.title %></li><% }) %></ul>
</body>
</html>
```

---

## üéØ Final takeaway

* `npm i ejs` ‚Üí install engine.
* `views/` ‚Üí put your `.ejs` files there (HTML with embedded JS).
* `app.set('view engine', 'ejs')` + `app.use(express.static(...))` ‚Üí wire EJS + static assets.
* `res.render('index', { message })` ‚Üí generate server HTML and send to client.