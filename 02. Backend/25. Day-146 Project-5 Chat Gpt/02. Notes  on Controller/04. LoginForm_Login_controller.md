
# 🔐 User Login Flow (EJS + Controller)

---

## 1️⃣ The Login Form (`login.ejs`)

```html
<form action="/auth/login" method="POST">
  <input type="text" name="identifier" placeholder="Email address / username" required>
  <input type="password" name="password" placeholder="Password" required>
  <button type="submit">Login</button>
  <p class="no-account">
    Don’t have an account? <a href="/auth/register">Sign up</a>
  </p>
</form>
```

* 📝 **Purpose** → To collect user input (either **email/username** + **password**).
* **`name="identifier"`** → Flexible field (user can type **email** or **username**).
* **`method="POST"`** → Securely sends data to the server.
* **`action="/auth/login"`** → Submits the form to the login route.

👉 Once submitted, the data travels as `req.body.identifier` and `req.body.password` to the controller.

---

## 2️⃣ The Login Controller (`postLoginController`)

```js
async function postLoginController(req, res) {
    const { identifier, password } = req.body;
```

* Extracts `identifier` and `password` from the form submission.
* This is the **starting point** of the authentication process.

---

## 3️⃣ Find the User in Database

```js
const user = await userModel.findOne({
    $or: [
        { email: identifier },
        { username: identifier }
    ]
});
```

* Uses **Mongoose’s `.findOne()`** to search in MongoDB.
* `$or` operator allows matching **either email OR username**.
* ✅ If found → `user` contains user document.
* ❌ If not found → Redirects back with error.

```js
if (!user) {
   return res.redirect('/login?error=User not found');
}
```

---

## 4️⃣ Verify Password

```js
const isPasswordValid = await bcrypt.compare(password, user.password);
```

* `bcrypt.compare()` checks if the entered password matches the **hashed password** stored in DB.
* Secure because **raw passwords are never stored**.

```js
if (!isPasswordValid) {
    return res.status(400).json({ message: "Invalid password" });
}
```

* ❌ Wrong password → Return error response.
* ✅ Correct password → Continue login flow.

---

## 5️⃣ Generate a JWT Token

```js
const token = jwt.sign({ id: user._id }, process.env.JWT_SECRETE);
```

* Creates a **JWT (JSON Web Token)** containing the user’s `_id`.
* Signed using a secret key (`JWT_SECRETE` from `.env`).
* This acts like a **digital pass 🎟️** proving the user’s identity.

---

## 6️⃣ Store Token in Cookie

```js
res.cookie("token", token);
```

* Sets the token in browser cookies.
* This allows **persistent login** across requests without re-entering credentials.

---

## 7️⃣ Send Response

```js
res.status(201).json({
    message: "user loggedin successfully",
    user
});
```

* Responds with a success message and user data.
* Could be used by frontend apps (React, Vue, etc.) to update UI.

---

# ✨ Beautiful Summary Notes

1. **Form Submission** → User enters **email/username + password** and submits.
2. **Find User** → Controller searches DB with `$or` condition.
3. **Validate Password** → Securely checks password with bcrypt.
4. **Generate JWT** → Creates a token with user ID inside.
5. **Set Cookie** → Token stored in browser → Auto-login for future requests.
6. **Send Response** → Confirms success or failure.

👉 In simple terms:
This code is like a **gatekeeper** 🛂.

* First, it **checks your ID (username/email)**.
* Then, it **verifies your secret code (password)**.
* If both are correct, it gives you a **VIP pass (JWT token)** 🎟️.
* That pass is stored in your pocket (cookie 🍪) so you don’t have to prove yourself again and again.

---