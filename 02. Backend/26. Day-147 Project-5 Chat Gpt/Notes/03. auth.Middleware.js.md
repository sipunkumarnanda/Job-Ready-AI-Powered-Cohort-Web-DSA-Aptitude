
# ğŸ“„ Code: `auth.middleware.js`

```js
import userModel from "../models/user.model.js";
import jwt from 'jsonwebtoken'
import dotenv from 'dotenv'

dotenv.config()

async function authUser(req, res, next) {
    const token = req.cookies?.token

    if(!token){
        return res.redirect("/auth/login")
    }

    try {
        const decoded = jwt.verify(token, process.env.JWT_SECRETE)

        const user = await userModel.findById(decoded.id)

        req.user = user

        next()
    } catch (error) {
        return res.redirect('/auth/login')
    }
}

export const authMiddleware = {
    authUser
}
```

---

# ğŸ“ Explanation with Notes

---

## 1. Importing Required Modules

```js
import userModel from "../models/user.model.js";
import jwt from 'jsonwebtoken'
import dotenv from 'dotenv'
```

* ğŸ“¦ **`userModel`** â†’ MongoDB model for users, used to fetch user details from DB.
* ğŸ”‘ **`jsonwebtoken` (jwt)** â†’ Library to verify and decode JWT tokens.
* âš™ï¸ **`dotenv`** â†’ Loads environment variables from `.env` file into `process.env`.

---

## 2. Loading Environment Variables

```js
dotenv.config()
```

* ğŸŒ Initializes `dotenv` so environment variables (like `JWT_SECRETE`) can be accessed.
* ğŸ”’ Keeps sensitive info (e.g., JWT secret key) outside the source code for **security**.

---

## 3. Defining the `authUser` Middleware Function

```js
async function authUser(req, res, next) {
```

* ğŸ›¡ï¸ Middleware to protect routes.
* ğŸ“¥ `req` â†’ request object.
* ğŸ“¤ `res` â†’ response object.
* â­ï¸ `next` â†’ function that passes control to the **next middleware/route handler** if authentication succeeds.

---

## 4. Extracting the Token from Cookies

```js
    const token = req.cookies?.token
```

* ğŸª Tries to read the **`token` cookie** from the request.
* â“ The `?.` (optional chaining) prevents errors if `cookies` is undefined.
* ğŸš« If no token is found â†’ user is not authenticated.

---

## 5. Checking If Token Exists

```js
    if(!token){
        return res.redirect("/auth/login")
    }
```

* ğŸš¨ If token is missing â†’ redirect user to `/auth/login`.
* ğŸ” Ensures **only logged-in users** can access protected routes.

---

## 6. Verifying and Decoding the Token

```js
    const decoded = jwt.verify(token, process.env.JWT_SECRETE)
```

* ğŸ” `jwt.verify()` â†’ Validates the token using secret key (`JWT_SECRETE`).
* âœ… If valid â†’ decodes payload (e.g., `{ id: userId }`).
* âŒ If invalid/expired â†’ goes to the `catch` block and redirects to login.

---

## 7. Fetching the User from Database

```js
    const user = await userModel.findById(decoded.id)
```

* ğŸ—‚ï¸ Looks up user details in the database using the `id` from the decoded token.
* ğŸ‘¤ Ensures the token actually belongs to a real, existing user.

---

## 8. Attaching User to `req`

```js
    req.user = user
```

* ğŸ“Œ Stores the user object in `req.user`.
* âš¡ Now subsequent middlewares/routes can access `req.user` to know **who is logged in**.

---

## 9. Passing Control to Next Middleware

```js
    next()
```

* â­ï¸ If everything is valid, the request continues to the **next middleware/route handler**.
* ğŸ”‘ This is what allows protected routes to execute only if the user is authenticated.

---

## 10. Handling Errors

```js
} catch (error) {
    return res.redirect('/auth/login')
}
```

* âš ï¸ If token is invalid/expired or DB lookup fails â†’ redirect to `/auth/login`.
* ğŸ›‘ Prevents unauthorized access.

---

## 11. Exporting the Middleware

```js
export const authMiddleware = {
    authUser
}
```

* ğŸ“¦ Exports `authUser` as part of `authMiddleware` object.
* ğŸ”§ Can be used in routes like:

```js
app.get("/dashboard", authMiddleware.authUser, (req, res) => {
    res.send(`Welcome ${req.user.name}`)
})
```

---

# ğŸŒŸ Summary

The `auth.middleware.js` does the following:

1. ğŸª **Extracts JWT token** from cookies.
2. ğŸ” **Verifies & decodes** the token using `jsonwebtoken`.
3. ğŸ—‚ï¸ **Fetches the user** from DB using `userModel`.
4. ğŸ“Œ Attaches user info to `req.user`.
5. â­ï¸ Allows request to continue only if user is authenticated.
6. ğŸš¨ Otherwise, redirects to `/auth/login`.

---