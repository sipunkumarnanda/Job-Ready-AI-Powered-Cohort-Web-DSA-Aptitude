
# 📄 Code: `auth.middleware.js`

```js
import userModel from "../models/user.model.js";
import jwt from 'jsonwebtoken'
import dotenv from 'dotenv'

dotenv.config()

async function authUser(req, res, next) {
    const token = req.cookies?.token

    if(!token){
        return res.redirect("/auth/login")
    }

    try {
        const decoded = jwt.verify(token, process.env.JWT_SECRETE)

        const user = await userModel.findById(decoded.id)

        req.user = user

        next()
    } catch (error) {
        return res.redirect('/auth/login')
    }
}

export const authMiddleware = {
    authUser
}
```

---

# 📝 Explanation with Notes

---

## 1. Importing Required Modules

```js
import userModel from "../models/user.model.js";
import jwt from 'jsonwebtoken'
import dotenv from 'dotenv'
```

* 📦 **`userModel`** → MongoDB model for users, used to fetch user details from DB.
* 🔑 **`jsonwebtoken` (jwt)** → Library to verify and decode JWT tokens.
* ⚙️ **`dotenv`** → Loads environment variables from `.env` file into `process.env`.

---

## 2. Loading Environment Variables

```js
dotenv.config()
```

* 🌍 Initializes `dotenv` so environment variables (like `JWT_SECRETE`) can be accessed.
* 🔒 Keeps sensitive info (e.g., JWT secret key) outside the source code for **security**.

---

## 3. Defining the `authUser` Middleware Function

```js
async function authUser(req, res, next) {
```

* 🛡️ Middleware to protect routes.
* 📥 `req` → request object.
* 📤 `res` → response object.
* ⏭️ `next` → function that passes control to the **next middleware/route handler** if authentication succeeds.

---

## 4. Extracting the Token from Cookies

```js
    const token = req.cookies?.token
```

* 🍪 Tries to read the **`token` cookie** from the request.
* ❓ The `?.` (optional chaining) prevents errors if `cookies` is undefined.
* 🚫 If no token is found → user is not authenticated.

---

## 5. Checking If Token Exists

```js
    if(!token){
        return res.redirect("/auth/login")
    }
```

* 🚨 If token is missing → redirect user to `/auth/login`.
* 🔐 Ensures **only logged-in users** can access protected routes.

---

## 6. Verifying and Decoding the Token

```js
    const decoded = jwt.verify(token, process.env.JWT_SECRETE)
```

* 🔍 `jwt.verify()` → Validates the token using secret key (`JWT_SECRETE`).
* ✅ If valid → decodes payload (e.g., `{ id: userId }`).
* ❌ If invalid/expired → goes to the `catch` block and redirects to login.

---

## 7. Fetching the User from Database

```js
    const user = await userModel.findById(decoded.id)
```

* 🗂️ Looks up user details in the database using the `id` from the decoded token.
* 👤 Ensures the token actually belongs to a real, existing user.

---

## 8. Attaching User to `req`

```js
    req.user = user
```

* 📌 Stores the user object in `req.user`.
* ⚡ Now subsequent middlewares/routes can access `req.user` to know **who is logged in**.

---

## 9. Passing Control to Next Middleware

```js
    next()
```

* ⏭️ If everything is valid, the request continues to the **next middleware/route handler**.
* 🔑 This is what allows protected routes to execute only if the user is authenticated.

---

## 10. Handling Errors

```js
} catch (error) {
    return res.redirect('/auth/login')
}
```

* ⚠️ If token is invalid/expired or DB lookup fails → redirect to `/auth/login`.
* 🛑 Prevents unauthorized access.

---

## 11. Exporting the Middleware

```js
export const authMiddleware = {
    authUser
}
```

* 📦 Exports `authUser` as part of `authMiddleware` object.
* 🔧 Can be used in routes like:

```js
app.get("/dashboard", authMiddleware.authUser, (req, res) => {
    res.send(`Welcome ${req.user.name}`)
})
```

---

# 🌟 Summary

The `auth.middleware.js` does the following:

1. 🍪 **Extracts JWT token** from cookies.
2. 🔍 **Verifies & decodes** the token using `jsonwebtoken`.
3. 🗂️ **Fetches the user** from DB using `userModel`.
4. 📌 Attaches user info to `req.user`.
5. ⏭️ Allows request to continue only if user is authenticated.
6. 🚨 Otherwise, redirects to `/auth/login`.

---