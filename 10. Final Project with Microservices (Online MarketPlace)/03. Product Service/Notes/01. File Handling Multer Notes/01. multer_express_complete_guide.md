



# ğŸ“¦ Multer in Express â€” Complete Backend Notes (Beginner â†’ Advanced)

This document explains **how to use Multer in an Express backend**,  
why we need it, how it works internally, and how to use it correctly with examples.

---

## ğŸ§  1. What is Multer?

**Multer** is an **Express middleware** used to handle **file uploads**.

ğŸ‘‰ It specifically handles:
- `multipart/form-data` requests
- Files + text fields together

> Express **cannot handle file uploads by itself**.

---

## â“ 2. Why do we need Multer?

## Problem âŒ
### When a user uploads a file, the browser sends:

### Content-Type: multipart/form-data

````

Express:
- Can parse JSON âŒ
- Can parse URL-encoded data âŒ
- Cannot parse multipart file streams âŒ

Result without Multer:
```js
req.body  // {}
req.files // undefined
````

---

### Solution âœ…

ğŸ‘‰ Use **Multer** to:

* Read file streams
* Extract files
* Attach them to `req`

---

## ğŸ”„ 3. How Multer Works (Internal Flow)

```
Browser
  â†“
multipart/form-data request
  â†“
Express receives raw stream
  â†“
Multer middleware intercepts
  â†“
Parses stream chunk by chunk
  â†“
Text fields â†’ req.body
Files â†’ req.file / req.files
  â†“
Controller executes
```

ğŸ“Œ Multer runs **before your controller**.

---

## ğŸ“‚ 4. Where does Multer store files?

Multer supports **two storage types** ğŸ‘‡

---

### ğŸ§  Memory Storage (MOST COMMON)

```js
multer.memoryStorage()
```

âœ… Stores file in RAM
âœ… Best for cloud uploads (ImageKit, S3, Cloudinary)
âŒ Not good for large files

Access file via:

```js
req.file.buffer
```

---

### ğŸ’¾ Disk Storage

```js
multer.diskStorage()
```

âœ… Saves file to local disk
âŒ You must delete files manually

Access file via:

```js
req.file.path
```

---

## ğŸ“¦ 5. Installing Multer

```bash
npm install multer
```

---

## âš™ï¸ 6. Basic Multer Setup

```js
const multer = require('multer');

const upload = multer({
  storage: multer.memoryStorage(),
});
```

This `upload` object is used as **middleware**.

---

## ğŸ§© 7. Multer Middleware Types (VERY IMPORTANT)

Multer has **different APIs**, and each changes how files appear in `req`.

---

### ğŸ”¹ `upload.single(fieldName)` â€” Single file

```js
upload.single('image')
```

Result:

```js
req.file   // âœ…
req.files  // âŒ undefined
```

Example:

```js
router.post(
  '/upload',
  upload.single('image'),
  controller
);
```

---

### ğŸ”¹ `upload.array(fieldName, maxCount)` â€” Multiple files

```js
upload.array('images', 5)
```

Result:

```js
req.files = [ file1, file2, ... ]
```

Example:

```js
router.post(
  '/upload',
  upload.array('images', 5),
  controller
);
```

---

### ğŸ”¹ `upload.fields([...])` â€” Multiple file fields

```js
upload.fields([
  { name: 'images', maxCount: 5 },
  { name: 'thumbnail', maxCount: 1 }
])
```

Result:

```js
req.files = {
  images: [...],
  thumbnail: [...]
}
```

---

## ğŸ“„ 8. Structure of a File Object

Each uploaded file looks like this:

```js
{
  fieldname: 'image',
  originalname: 'photo.png',
  mimetype: 'image/png',
  size: 23456,
  buffer: <Buffer ...>
}
```

ğŸ“Œ `buffer` exists **only with memoryStorage**.

---

## ğŸ›£ï¸ 9. Using Multer in Routes (Correct Order)

âŒ Wrong:

```js
router.post('/x', controller, upload.single('file'));
```

âœ… Correct:

```js
router.post('/x', upload.single('file'), controller);
```

Middleware **must run before controller**.

---

## ğŸ” 10. Using Multer with Auth Middleware

```js
router.post(
  '/products',
  authenticate,
  authorize('seller'),
  upload.array('images', 5),
  createProduct
);
```

Order matters:

1. Auth
2. Authorization
3. Multer
4. Controller

---

## ğŸ§ª 11. Testing Multer Routes (Supertest)

```js
await request(app)
  .post('/api/upload')
  .attach('image', 'tests/fixtures/a.png')
  .field('title', 'Test Product');
```

---

## ğŸ›¡ï¸ 12. File Validation & Security (IMPORTANT)

### Limit file size

```js
limits: { fileSize: 2 * 1024 * 1024 } // 2MB
```

---

### Allow only images

```js
fileFilter: (req, file, cb) => {
  if (!file.mimetype.startsWith('image/')) {
    return cb(new Error('Only images allowed'));
  }
  cb(null, true);
}
```

---

## ğŸ§¹ 13. How long does Multer keep files in RAM?

ğŸ‘‰ **Only for the request lifecycle**

Timeline:

```
Request starts
 â†’ Multer buffers file
 â†’ Controller uses file
 â†’ Response sent
 â†’ Request ends
 â†’ RAM freed automatically
```

âŒ Multer does NOT store files permanently
âŒ You do NOT delete buffers manually

---

## âš ï¸ 14. Common Mistakes (VERY IMPORTANT)

âŒ Expecting `req.files` with `single()`
âŒ Wrong field name
âŒ Missing `multipart/form-data`
âŒ No file size limits
âŒ Uploading large files with memoryStorage

---

## ğŸ§  15. Best Practices (Production)

âœ… Use memoryStorage for small files
âœ… Set size limits
âœ… Upload immediately to cloud
âœ… Never store buffers globally
âœ… Use streaming for large files

---

## ğŸ¯ 16. Mental Model (Remember This)

> Multer is a **temporary file handler**
> It reads file streams, attaches them to `req`,
> and releases memory once the request ends.

---

## âœ… 17. One-Line Summary

**Multer is an Express middleware that parses multipart/form-data requests, temporarily stores files, and makes them available in `req.file` or `req.files`.**

```

---