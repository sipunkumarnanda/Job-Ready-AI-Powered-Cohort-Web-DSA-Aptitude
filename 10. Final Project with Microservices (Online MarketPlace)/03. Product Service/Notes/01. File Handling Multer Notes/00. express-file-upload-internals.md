


## 1ï¸âƒ£ What happens when the server runs for the first time

### Your code

```js
const upload = multer({
  storage: multer.memoryStorage()
});

router.post(
  '/',
  createAuthMiddleware(['admin', 'seller']),
  upload.array('images', 5),
  productController.createProduct
);
```

### ğŸ”¹ Server startup phase (NO REQUEST yet)

When Node.js runs this file:

#### Step 1: `multer(...)` is executed

```js
const upload = multer({
  storage: multer.memoryStorage()
});
```

âœ”ï¸ This:

* Creates a **multer instance**
* Configures it to:

  * Store files **in RAM**
  * Expose files via `req.files`
* **No files are uploaded yet**
* **No request is involved**

ğŸ‘‰ This just prepares a **tool**, not execution.

---

#### Step 2: `upload.array('images', 5)` is CALLED

This is important.

```js
upload.array('images', 5)
```

âœ”ï¸ This **does NOT upload anything now**
âœ”ï¸ This **RETURNS a middleware function**

Think of it as:

```js
const multerMiddleware = upload.array('images', 5);
```

ğŸ‘‰ That returned function has this signature:

```js
(req, res, next) => { /* multer logic */ }
```

---

#### Step 3: Express registers the route

```js
router.post('/', middleware1, middleware2, controller)
```

Express stores internally:

```
POST /
  â†’ createAuthMiddleware(...)
  â†’ multerMiddleware
  â†’ createProduct
```

ğŸ“Œ **Nothing runs yet**
ğŸ“Œ Express is just building a **route stack**

---

## 2ï¸âƒ£ What Express has internally after registration

Express internally creates something like:

```js
{
  method: 'POST',
  path: '/',
  handlers: [
    createAuthMiddleware(['admin','seller']),
    upload.array('images', 5),
    productController.createProduct
  ]
}
```

ğŸš¨ Important:

* `upload.array()` has already been **called**
* The **returned function** is what Express stores
* Express NEVER calls `upload.array()` again

---

## 3ï¸âƒ£ What happens when a user sends a request

### User sends:

```
POST /api/products
Content-Type: multipart/form-data
Body:
  images: [file1, file2]
  name: "Laptop"
  price: 1000
```

Now execution begins.

---

## 4ï¸âƒ£ Express request lifecycle (real execution)

### Step 1: Express matches the route

âœ”ï¸ Method = `POST`
âœ”ï¸ Path = `/`
âœ”ï¸ Route found

Now Express starts calling middleware **in order**.

---

## 5ï¸âƒ£ Middleware execution (VERY IMPORTANT)

### â‘  `createAuthMiddleware(['admin','seller'])`

```js
(req, res, next) => {
  // verify token
  // check role
}
```

âœ”ï¸ If auth fails â†’ response sent â†’ STOP
âœ”ï¸ If auth passes â†’ `next()` â†’ move forward

---

### â‘¡ `upload.array('images', 5)` middleware runs

Now multer becomes active.

#### What multer does internally

1. **Checks Content-Type**

   ```http
   multipart/form-data
   ```

2. **Parses request stream**

   * Text fields â†’ `req.body`
   * Files â†’ `req.files`

3. **Applies rules**

   * Field name must be `"images"`
   * Maximum files = `5`
   * Storage = `memoryStorage`

4. **Stores files in memory**
   Each file becomes:

   ```js
   {
     fieldname: 'images',
     originalname: 'photo.png',
     mimetype: 'image/png',
     buffer: <Buffer ...>,
     size: 12345
   }
   ```

5. **Attaches files**

   ```js
   req.files = [file1, file2]
   ```

6. **Calls `next()`**
   âœ”ï¸ Only after parsing is done

ğŸ“Œ At this point:

```js
req.body   // form fields
req.files  // array of uploaded files
```

---

### â‘¢ `productController.createProduct` runs

```js
(req, res) => {
  console.log(req.files); // âœ… available
  console.log(req.body);  // âœ… available
}
```

Now you can:

* Upload buffers to cloud
* Save product in DB
* Return response

---

## 6ï¸âƒ£ Summary: timeline view

### ğŸŸ¢ Server start

```
multer()            â†’ creates config
upload.array()      â†’ returns middleware
router.post()       â†’ registers middleware
```

### ğŸ”µ User sends request

```
Express matches route
â†’ Auth middleware runs
â†’ Multer middleware parses files
â†’ Controller executes
â†’ Response sent
```

---

## 7ï¸âƒ£ Key concepts (VERY IMPORTANT)

### âŒ What does NOT happen

* `upload.array()` does NOT run on server startup
* Files are NOT uploaded during registration
* Multer does NOT store files until request arrives

---

### âœ… What actually happens

| Phase           | Action                              |
| --------------- | ----------------------------------- |
| Server start    | Middleware functions are registered |
| Request arrives | Middleware functions are executed   |
| upload.array    | Parses multipart data               |
| memoryStorage   | Stores files in RAM                 |
| Controller      | Uses `req.files`                    |

---

## 8ï¸âƒ£ Mental model (best way to remember)

Think of it like this:

```js
router.post(
  '/',
  fn1, // registered now, executed later
  fn2, // registered now, executed later
  fn3  // registered now, executed later
);
```

ğŸ‘‰ Express is like:

> â€œIâ€™ll remember these functions, and Iâ€™ll call them **only when someone hits this route**.â€

---
