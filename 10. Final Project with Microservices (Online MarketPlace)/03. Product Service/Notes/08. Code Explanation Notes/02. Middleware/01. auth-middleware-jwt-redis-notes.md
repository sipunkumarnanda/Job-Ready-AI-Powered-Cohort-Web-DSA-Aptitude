


# ğŸ” Authentication & Authorization Middleware â€“ Detailed Notes

---

## ğŸ“Œ Where This Middleware Is Used (Route Example)

```js
router.post(
  '/',
  createAuthMiddleware(['admin', 'seller']),
  upload.array('images', 5),
  productValidators.createProductValidators,
  productController.createProduct
);
```

### ğŸ§  Meaning (High Level)

This route means:

1. User **must be authenticated**
2. User **must have role `admin` or `seller`**
3. User can upload up to **5 images**
4. Request data is **validated**
5. Product is **created**

---

## ğŸ“Œ Complete Auth Middleware Code (At One Place)

```js
const jwt = require("jsonwebtoken");
const redis = require('../db/redis.js');

function createAuthMiddleware(roles = ["user"]) {

  return async function authMiddleware(req, res, next) {
    const token =
      req.cookies?.token || req.headers?.authorization?.split(" ")[1];

    if (!token) {
      return res.status(401).json({
        message: "Authentication token is missing",
      });
    }

    try {
      try {
        const isBlacklisted = await redis.get(`blacklist:${token}`);

        if (isBlacklisted) {
          res.clearCookie("token", {
            httpOnly: true,
            secure: true,
            sameSite: "strict",
          });

          return res.status(401).json({
            message: "unauthorized : Token has been revoked",
          });
        }
      } catch (error) {
        console.error("Redis error in auth middleware:", error);
        return res.status(503).json({
          message: "Authentication service unavailable",
        });
      }

      const decoded = jwt.verify(token, process.env.JWT_SECRET);

      if (!roles.includes(decoded.role)) {
        return res.status(403).json({
          message: "forbidden : Insufficient permissions",
        });
      }

      req.user = decoded;
      next();
    } catch (error) {
      return res.status(401).json({
        message: "unauthorized : Invalid token",
      });
    }
  };
}

module.exports = createAuthMiddleware;
```

---

## ğŸ§  What Is This Middleware?

This middleware handles **two things**:

1ï¸âƒ£ **Authentication** â†’ *Who are you?*
2ï¸âƒ£ **Authorization** â†’ *Are you allowed to do this?*

âœ” Uses **JWT**
âœ” Uses **Redis** for token revocation
âœ” Supports **role-based access control (RBAC)**

---

## 1ï¸âƒ£ Middleware Factory Function ğŸ­

```js
function createAuthMiddleware(roles = ["user"])
```

### Why a function returning a middleware?

* Allows **dynamic roles per route**
* Same middleware, different permissions

### Example:

```js
createAuthMiddleware(['admin'])
createAuthMiddleware(['seller'])
createAuthMiddleware(['admin', 'seller'])
```

ğŸ§  This is called a **middleware factory**

---

## 2ï¸âƒ£ Extracting JWT Token ğŸ”

```js
const token =
  req.cookies?.token || req.headers?.authorization?.split(" ")[1];
```

### Supported token sources:

* ğŸª Cookies (`req.cookies.token`)
* ğŸ” Authorization header

  ```
  Authorization: Bearer <token>
  ```

âœ” Makes API flexible
âœ” Works for browser & mobile apps

---

## 3ï¸âƒ£ Missing Token Check âŒ

```js
if (!token) {
  return res.status(401).json({
    message: "Authentication token is missing",
  });
}
```

### Why?

* No token â†’ user not logged in
* Correct status: **401 Unauthorized**

---

## 4ï¸âƒ£ Token Blacklist Check (Logout Support) ğŸš«

```js
const isBlacklisted = await redis.get(`blacklist:${token}`);
```

### Why Redis?

* JWT is **stateless**
* Redis allows:

  * logout
  * token revocation
  * session invalidation

### Example:

```js
blacklist:<jwt-token> â†’ true
```

---

## 5ï¸âƒ£ Handling Revoked Token ğŸ”¥

```js
if (isBlacklisted) {
  res.clearCookie("token", {...});
  return res.status(401).json({
    message: "unauthorized : Token has been revoked",
  });
}
```

âœ” Clears cookie
âœ” Blocks access
âœ” Improves security

---

## 6ï¸âƒ£ Redis Failure Handling ğŸ›‘

```js
catch (error) {
  return res.status(503).json({
    message: "Authentication service unavailable",
  });
}
```

### Why `503`?

* Redis is an **external dependency**
* Auth service temporarily unavailable

ğŸ§  This shows **production-grade error handling**

---

## 7ï¸âƒ£ JWT Verification ğŸ”‘

```js
const decoded = jwt.verify(token, process.env.JWT_SECRET);
```

### What this does:

* Verifies token signature
* Checks expiration
* Decodes payload

Example payload:

```js
{
  id: "userId",
  role: "seller",
  email: "test@mail.com"
}
```

---

## 8ï¸âƒ£ Role-Based Authorization (RBAC) ğŸ§¾

```js
if (!roles.includes(decoded.role)) {
  return res.status(403).json({
    message: "forbidden : Insufficient permissions",
  });
}
```

### Difference:

| Status | Meaning                   |
| ------ | ------------------------- |
| 401    | Not logged in             |
| 403    | Logged in but not allowed |

âœ” Clean separation of auth & permission

---

## 9ï¸âƒ£ Attaching User to Request ğŸ‘¤

```js
req.user = decoded;
```

### Why?

* Makes user data available in:

  * controllers
  * services
* Example usage:

```js
req.user.id
req.user.role
```

---

## ğŸ”Ÿ Calling `next()` ğŸš¦

```js
next();
```

âœ” Passes control to next middleware
âœ” If auth fails â†’ request never reaches controller

---

## ğŸ” Request Flow (Visual)

```txt
Request
  â†“
Auth Middleware
  â†“
JWT Verify
  â†“
Role Check
  â†“
req.user set
  â†“
Controller
```

---

## ğŸ¯ Interview-Ready Explanation (Impressive)

> â€œI implemented a role-based authentication middleware using JWT and Redis. It verifies tokens, checks revocation status, enforces role-based access control, and securely attaches user context to the request for downstream handlers.â€

### Bonus Line (Very Impressive):

> â€œUsing Redis for token blacklisting allows stateless JWT authentication while still supporting secure logout and token revocation.â€

---

## ğŸ§  Key Takeaways (For Revision)

âœ… Middleware factory pattern
âœ… JWT authentication
âœ… Redis-based token revocation
âœ… Role-based authorization
âœ… Secure cookie handling
âœ… Proper HTTP status codes
âœ… Production-ready auth design

---