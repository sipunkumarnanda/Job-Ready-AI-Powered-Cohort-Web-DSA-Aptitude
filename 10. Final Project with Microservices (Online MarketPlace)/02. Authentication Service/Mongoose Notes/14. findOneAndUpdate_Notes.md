


# ğŸ› ï¸ `findOneAndUpdate()` in Mongoose (In-Depth Notes)

`findOneAndUpdate()` is one of the **most important update methods** provided by **Mongoose** for working with **MongoDB**.

It allows you to **find a document, update it, and return a document in a single operation**.

---

## ğŸ“Œ 1. What Is `findOneAndUpdate()`?

### âœ… Definition

`findOneAndUpdate()`:

* Finds **one document** that matches a condition
* Updates it using **update operators**
* Returns **the document (old or updated)**

ğŸ“Œ It performs **find + update + return** in **one atomic operation**.

---

## â“ 2. Why `findOneAndUpdate()` Is Needed

### Problem with Other Update Methods

| Method         | Limitation                             |
| -------------- | -------------------------------------- |
| `updateOne()`  | Updates but âŒ does not return document |
| `updateMany()` | Bulk update, âŒ no document return      |
| `find()`       | Reads only, âŒ no update                |

ğŸ‘‰ `findOneAndUpdate()` solves this by:

* Updating the document
* Returning it immediately

---

## ğŸ¯ 3. When to Use `findOneAndUpdate()` in Mongoose

Use `findOneAndUpdate()` when:

âœ… You need the **updated document immediately**
âœ… You want to **update & fetch in one query**
âœ… You are working with:

* User profile updates
* Status changes
* Counters (likes, views)
* Account balances
  âœ… You want **atomic and safe updates**

---

## ğŸ“ 4. Where Is `findOneAndUpdate()` Used?

### Mongoose Model Method

```js
Model.findOneAndUpdate()
```

ğŸ“Œ Commonly used in:

* REST APIs
* Controllers / services
* Production applications

---

## ğŸ§± 5. Syntax of `findOneAndUpdate()` (Mongoose)

```js
Model.findOneAndUpdate(
  filter,
  update,
  options
)
```

---

## ğŸ§© 6. Parameters Explained

### ğŸ” Filter

* Selects the document to update
* Same as `findOne()`

```js
{ email: "user@gmail.com" }
```

---

### ğŸ› ï¸ Update

* Uses **update operators** (`$set`, `$inc`, `$push`)
* Prevents full document replacement

```js
{ $set: { age: 30 } }
```

---

### âš™ï¸ Options (Very Important)

| Option                | Meaning                  |
| --------------------- | ------------------------ |
| `new: true`           | Return updated document  |
| `upsert: true`        | Insert if no match found |
| `runValidators: true` | Apply schema validation  |
| `select`              | Choose fields to return  |

ğŸ“Œ By default, Mongoose returns the **old document**.

---

# ğŸ§ª 7. Examples (Schema Before Each Example)

---

## Example 1ï¸âƒ£: Basic Update and Return Updated Document

### ğŸ“„ Mongoose Schema

```js
const UserSchema = new mongoose.Schema({
  name: String,
  age: Number,
  city: String
});
```

### ğŸ§ª Mongoose Query

```js
User.findOneAndUpdate(
  { name: "Amit" },
  { $set: { age: 30 } },
  { new: true }
);
```

### âœ… Explanation

* Finds first user named Amit
* Updates age
* Returns **updated document** due to `new: true`

---

## Example 2ï¸âƒ£: Returning Old vs New Document

### ğŸ“„ Schema

```js
const UserSchema = new mongoose.Schema({
  email: String,
  isActive: Boolean
});
```

### ğŸ§ª Query (Default Behavior)

```js
User.findOneAndUpdate(
  { email: "amit@gmail.com" },
  { $set: { isActive: true } }
);
```

### âš ï¸ Explanation

* Returns **old document**
* Because `new: true` is not provided

---

## Example 3ï¸âƒ£: Incrementing a Value (Counter Example)

### ğŸ“„ Schema

```js
const PostSchema = new mongoose.Schema({
  title: String,
  views: Number
});
```

### ğŸ§ª Query

```js
Post.findOneAndUpdate(
  { title: "MongoDB Guide" },
  { $inc: { views: 1 } },
  { new: true }
);
```

### âœ… Explanation

* Atomically increments views
* Returns updated views count
* Ideal for counters and analytics

---

## Example 4ï¸âƒ£: Updating Nested Fields

### ğŸ“„ Schema

```js
const UserSchema = new mongoose.Schema({
  name: String,
  address: {
    city: String,
    pincode: Number
  }
});
```

### ğŸ§ª Query

```js
User.findOneAndUpdate(
  { name: "Amit" },
  { $set: { "address.city": "Delhi" } },
  { new: true }
);
```

### âœ… Explanation

* Uses **dot notation**
* Updates nested field safely

---

## Example 5ï¸âƒ£: Using `upsert` Option

### ğŸ“„ Schema

```js
const ProductSchema = new mongoose.Schema({
  item: String,
  price: Number
});
```

### ğŸ§ª Query

```js
Product.findOneAndUpdate(
  { item: "Pen" },
  { $set: { price: 10 } },
  { upsert: true, new: true }
);
```

### âœ… Explanation

* If Pen exists â†’ update
* If not â†’ insert new document
* Returns inserted document

---

## Example 6ï¸âƒ£: Running Schema Validation

### ğŸ“„ Schema

```js
const UserSchema = new mongoose.Schema({
  name: { type: String, required: true },
  age: { type: Number, min: 18 }
});
```

### ğŸ§ª Query

```js
User.findOneAndUpdate(
  { name: "Amit" },
  { $set: { age: 15 } },
  { new: true, runValidators: true }
);
```

### âš ï¸ Explanation

* Validation runs because of `runValidators: true`
* Without it â†’ invalid data could be saved

---

## ğŸ“¦ 8. What Does `findOneAndUpdate()` Return in Mongoose?

### ğŸ“¤ Return Value

* Returns a **single document**
* Can be:

  * Old document (default)
  * Updated document (`new: true`)
* Returns `null` if no match (unless upsert is used)

---

### ğŸ“Š Return Summary

| Option               | Returned Value    |
| -------------------- | ----------------- |
| `new: false`         | Old document      |
| `new: true`          | Updated document  |
| No match + no upsert | `null`            |
| Upsert               | Inserted document |

---

## âš ï¸ 9. Important Rules & Best Practices

âœ… Always use update operators (`$set`, `$inc`)
âœ… Use `new: true` in almost all cases
âœ… Use `runValidators: true` for safe updates
âŒ Do not use for bulk updates
ğŸ“Œ Use `updateMany()` for multiple documents

---

## ğŸ”„ 10. Comparison with Other Mongoose Update Methods

| Method               | Updates | Returns Doc |
| -------------------- | ------- | ----------- |
| `updateOne()`        | One     | âŒ No        |
| `updateMany()`       | Many    | âŒ No        |
| `findOneAndUpdate()` | One     | âœ… Yes       |

---

## ğŸ“ 11. Key Exam & Interview Points

* `findOneAndUpdate()` updates **only one document**
* Returns **old or updated document**
* Atomic operation
* Most commonly used update method in Mongoose
* Requires `new: true` to get updated data

---