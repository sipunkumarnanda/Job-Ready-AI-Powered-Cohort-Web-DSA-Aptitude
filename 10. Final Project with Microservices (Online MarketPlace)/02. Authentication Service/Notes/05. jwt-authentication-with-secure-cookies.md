

# ğŸ” JWT Generation & Secure Cookie Authentication

### ğŸ§  In-Depth Notes (Node.js â€¢ Express â€¢ Security)

---

## ğŸ“Œ Code Under Discussion

```js
const token = jwt.sign(
  {
    id: user._id,
    username: user.username,
    email: user.email,
    role: user.role,
  },
  process.env.JWT_SECRETE,
  { expiresIn: "1d" }
);

res.cookie("token", token, {
  httpOnly: true,
  secure: true,
  sameSite: "strict",
  maxAge: 24 * 60 * 60 * 1000,
});
```

---

## ğŸ§  What Is JWT (JSON Web Token)?

> **JWT** is a compact, self-contained token used for **authentication and authorization** between client and server.

A JWT consists of **three parts**:

```
HEADER . PAYLOAD . SIGNATURE
```

* **Header** â†’ algorithm & token type
* **Payload** â†’ user data (claims)
* **Signature** â†’ ensures integrity & authenticity

ğŸ“Œ JWT is **signed, not encrypted**

---

## ğŸ§± `jwt.sign()` â€“ Token Creation Explained

### ğŸ“Œ Method Signature

```js
jwt.sign(payload, secretKey, options)
```

---

### ğŸ§© 1ï¸âƒ£ Payload (Claims)

```js
{
  id: user._id,
  username: user.username,
  email: user.email,
  role: user.role,
}
```

#### ğŸ§  Purpose of Payload

âœ” Identifies the user
âœ” Used for authorization checks
âœ” Accessible after verification

#### âš ï¸ Security Rule (VERY IMPORTANT)

> âŒ **Never store sensitive data in JWT**

Do NOT include:

* Passwords
* OTPs
* API keys
* Secrets

JWT payload can be decoded easily âš ï¸

---

### ğŸ§© 2ï¸âƒ£ Secret Key

```js
process.env.JWT_SECRETE
```

#### ğŸ§  Role of Secret Key

âœ” Signs the token
âœ” Prevents tampering
âœ” Required for verification

#### ğŸ“Œ Best Practices

* Store in `.env`
* Use long, random string
* Never expose to client

```env
JWT_SECRETE=ksdf89sdf9sdf89sdf98sdf
```

---

### ğŸ§© 3ï¸âƒ£ Token Expiry

```js
{ expiresIn: "1d" }
```

#### ğŸ§  Why Expiry Matters

âœ” Limits damage if token is stolen
âœ” Forces re-authentication
âœ” Improves security posture

#### â±ï¸ Common Values

| Token Type    | Expiry   |
| ------------- | -------- |
| Access Token  | 15m â€“ 1h |
| Auth Token    | 1d       |
| Refresh Token | 7d â€“ 30d |

---

## ğŸª Why Store JWT in Cookies?

> Cookies allow **automatic token transmission** with each request and can be **secured against JavaScript access**.

### âœ… Advantages

âœ” Not accessible via JS
âœ” Auto-sent with requests
âœ” Safer than localStorage

---

## ğŸ›¡ï¸ Cookie Options Explained (CRITICAL)

---

### ğŸ” `httpOnly: true`

```js
httpOnly: true
```

#### ğŸ§  Purpose

âœ” Prevents JavaScript access
âœ” Protects against XSS attacks

```js
document.cookie // âŒ cannot read token
```

---

### ğŸ”’ `secure: true`

```js
secure: true
```

#### ğŸ§  Purpose

âœ” Cookie sent **only over HTTPS**

#### ğŸ“Œ Environment Tip

```js
secure: process.env.NODE_ENV === "production"
```

---

### ğŸ§· `sameSite: "strict"`

```js
sameSite: "strict"
```

#### ğŸ§  Purpose

âœ” Prevents CSRF attacks
âœ” Cookie sent only from same site

#### ğŸ”„ Options

| Value  | Behavior                            |
| ------ | ----------------------------------- |
| strict | Maximum security                    |
| lax    | Balanced                            |
| none   | Cross-site allowed (requires HTTPS) |

---

### â³ `maxAge`

```js
maxAge: 24 * 60 * 60 * 1000
```

#### ğŸ§  Purpose

âœ” Controls how long cookie lives
âœ” Time in **milliseconds**

ğŸ“Œ Must match JWT expiry

---

## â±ï¸ JWT Expiry vs Cookie Expiry

| Aspect      | JWT            | Cookie           |
| ----------- | -------------- | ---------------- |
| Controls    | Token validity | Storage duration |
| Enforced by | Server         | Browser          |
| Must align  | âœ… Yes          | âœ… Yes            |

---

## ğŸ”„ Authentication Flow (Mental Model)

```
Login/Register
     â†“
JWT Created
     â†“
Stored in httpOnly Cookie
     â†“
Browser auto-sends cookie
     â†“
Auth middleware verifies token
```

---

## ğŸ§  Why This Is a Production-Grade Pattern

âœ” Prevents XSS
âœ” Reduces CSRF risk
âœ” Clean separation of auth
âœ” Works well with browsers

---

## ğŸ§ª Interview Questions & Answers

### â“ Why use httpOnly cookies instead of localStorage?

ğŸ‘‰ localStorage is vulnerable to XSS.

---

### â“ Is JWT encrypted?

ğŸ‘‰ âŒ No, it is only signed.

---

### â“ Why include role in JWT?

ğŸ‘‰ Enables role-based authorization without DB hits.

---

### â“ What happens when JWT expires?

ğŸ‘‰ User must re-login or refresh token.

---

## ğŸ§¾ Golden Rules (MEMORIZE)

âœ¨ JWT is signed, not encrypted
âœ¨ Never store secrets in payload
âœ¨ Always set expiry
âœ¨ Use httpOnly + sameSite cookies
âœ¨ Align JWT & cookie lifetime

---